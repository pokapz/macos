name: MacOS VNC Pinggy Final

on: workflow_dispatch

jobs:
  vnc:
    runs-on: macos-latest
    steps:
      - name: Setup VNC and Pinggy Tunnel
        run: |
          # Пароль сразу выводим — не потеряем
          PASSWORD=$(openssl rand -base64 12 | tr -dc 'A-Za-z0-9!@#$%^&*()_+')
          echo "==============  топчик  ====================="
          echo "Пароль VNC: $PASSWORD"
          echo "============================================="
          echo "::notice title=VNC Password::$PASSWORD"

          # Включаем VNC
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on -allowAccessFor -allUsers -privs -all \
            -clientopts -setvnclegacy -vnclegacy yes -setvncpw -vncpw "$PASSWORD" -restart -agent

          # Запуск Pinggy в фоне правильно: -T (no tty), -f (background), -N (no command), -o ExitOnForwardFailure=yes (чтобы падал если не коннект)
          nohup sh -c "curl -s https://pinggy.io/tunnel | ssh -T -f -N -p 443 -o StrictHostKeyChecking=no -R0:localhost:5900 a.pinggy.io" > tunnel.log 2>&1 &

          # Ждём 20–30 сек и захватываем ссылку (Pinggy выводит в stdout/stderr)
          sleep 25
          cat tunnel.log

          TUNNEL_URL=$(grep -o "https://[a-z0-9.-]*\.a\.pinggy\.link" tunnel.log | tail -1 || echo "")
          if [ -z "$TUNNEL_URL" ]; then
            echo "Туннель не запустился, смотри лог выше"
            exit 1
          fi

          HOST=$(echo "$TUNNEL_URL" | sed 's/https:\/\///')

          echo "==============  топчик  ====================="
          echo "Адрес: $HOST"
          echo "Порт: 5900"
          echo "Пароль VNC: $PASSWORD"
          echo "============================================="
          echo "::notice title=VNC Ready::Host: $HOST (port 5900) | Pass: $PASSWORD"

          sleep 21600
