name: MacOS VNC Pinggy Free

on: workflow_dispatch

jobs:
  vnc:
    runs-on: macos-latest
    steps:
      - name: Setup VNC and Pinggy Tunnel
        run: |
          # Пароль выводим сразу
          PASSWORD=$(openssl rand -base64 12 | tr -dc 'A-Za-z0-9!@#$%^&*()_+')
          echo "==============  топчик  ====================="
          echo "Пароль VNC: $PASSWORD"
          echo "============================================="
          echo "::notice title=VNC Password::$PASSWORD"

          # Включаем VNC
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on -allowAccessFor -allUsers -privs -all \
            -clientopts -setvnclegacy -vnclegacy yes -setvncpw -vncpw "$PASSWORD" -restart -agent

          # Запуск Pinggy free TCP в фоне (qr@ — без токена, -N -T -f для non-interactive)
          nohup ssh -T -f -N -p 443 -o StrictHostKeyChecking=no -R0:localhost:5900 qr@free.pinggy.io > tunnel.log 2>&1 &

          # Ждём 30 сек и выводим лог с адресом
          sleep 30
          cat tunnel.log

          # Парсим адрес
          TUNNEL_URL=$(grep -o "https://[a-z0-9.-]*\.free\.pinggy\.link" tunnel.log | tail -1 || echo "Не найдено")
          if [ "$TUNNEL_URL" = "Не найдено" ]; then
            grep -o "https://[a-z0-9.-]*\.a\.pinggy\.link" tunnel.log | tail -1 || echo "Туннель не запустился"
          else
            echo "$TUNNEL_URL"
          fi > tunnel_url.txt

          HOST=$(cat tunnel_url.txt | sed 's/https:\/\///')

          if [ -z "$HOST" ]; then
            echo "Ошибка туннеля, смотри лог выше"
            exit 1
          fi

          echo "==============  топчик  ====================="
          echo "Адрес: $HOST"
          echo "Порт: 5900"
          echo "Пароль VNC: $PASSWORD"
          echo "============================================="
          echo "::notice title=VNC Ready::Host: $HOST (port 5900) | Pass: $PASSWORD"

          sleep 21600
